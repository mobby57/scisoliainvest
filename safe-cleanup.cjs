#!/usr/bin/env node

/**
 * Safe Cleanup Script
 * 
 * Safely removes validated files after manual review.
 * Requires cleanup-analysis-data.json generated by cleanup-analysis.cjs
 * 
 * Usage:
 *   1. Review CLEANUP_ANALYSIS_REPORT.md
 *   2. Edit this script to uncomment files you want to delete
 *   3. Run: node safe-cleanup.cjs
 */

const fs = require('fs');
const { execSync } = require('child_process');

// Read analysis data
let analysisData;
try {
  analysisData = JSON.parse(fs.readFileSync('cleanup-analysis-data.json', 'utf8'));
} catch (err) {
  console.error('‚ùå Erreur: Ex√©cutez d\'abord cleanup-analysis.cjs pour g√©n√©rer cleanup-analysis-data.json');
  process.exit(1);
}

console.log('üßπ Script de Nettoyage S√©curis√©\n');
console.log(`Fichiers candidats d√©tect√©s: ${analysisData.potentiallyRemovable.length}\n`);

// FILES TO DELETE - UNCOMMENT AFTER MANUAL VALIDATION
// D√©commentez uniquement les fichiers que vous avez valid√©s manuellement
const filesToDelete = [
  // ‚ö†Ô∏è VALIDATION REQUISE: V√©rifiez chaque fichier avant de d√©commenter!
  
  // === OLD TODO FILES ===
  // Uncomment TODO files that are no longer needed:
  // 'TODO.md',
  // 'TODO_API_DOCUMENTATION_UPDATE.md',
  // 'TODO_COMBINED_FRONTEND_BACKEND.md',
  // 'TODO_DOCKER_FIX.md',
  // 'TODO_DOCUMENT_UPLOAD_FIXES.md',
  // 'TODO_ESLINT_FIXES_KYC.md',
  // 'TODO_PHASE_0.md',
  // 'TODO_PHASE_1_IMPLEMENTATION.md',
  // 'TODO_PRIORITAIRE.md',
  // 'TODO_TENANT_SCHEMA_UPDATES.md',
  // 'TODO_TENANT_SCÊûÅMA_UPDATES.md',
  // 'TODO_TESTS.md',
  // 'TODO_TS_CORRECTIONS.md',
  // 'TODO_TS_FIXES.md',
  
  // === HTML FILES (STATIC) ===
  // Uncomment if these HTML files are no longer used:
  // 'setup-checklist-visual.html',
  // 'test-results/postman-report.html',
  // 'website/admin/analytics.html',
  // 'website/auth/login.html',
  // 'website/auth/register.html',
  // 'website/dashboard/index.html',
  // 'website/dashboard/investments.html',
  // 'website/dashboard/kyc.html',
  // 'website/dashboard/transactions.html',
  // 'website/index.html',
  // 'website/legal/legal-notice.html',
  // 'website/legal/mentions.html',
  // 'website/legal/terms.html',
  // 'website/properties/index.html',
  
  // === BATCH/POWERSHELL SCRIPTS ===
  // Uncomment if these scripts are no longer referenced:
  // 'start-backend.bat',
  // 'start-server.bat',
  // 'test-backend.ps1',
];

// Safety checks
if (filesToDelete.length === 0) {
  console.log('‚ÑπÔ∏è  Aucun fichier √† supprimer.');
  console.log('');
  console.log('üìã Instructions:');
  console.log('1. Consultez CLEANUP_ANALYSIS_REPORT.md');
  console.log('2. √âditez safe-cleanup.cjs');
  console.log('3. D√©commentez les fichiers √† supprimer dans la liste filesToDelete');
  console.log('4. Relancez ce script');
  console.log('');
  process.exit(0);
}

console.log('üìù Fichiers √† supprimer:');
filesToDelete.forEach((file, i) => {
  console.log(`   ${i + 1}. ${file}`);
});
console.log('');

// Create backup branch
console.log('üíæ Cr√©ation de la branche de sauvegarde...');
try {
  const currentBranch = execSync('git branch --show-current', { encoding: 'utf8' }).trim();
  const backupBranch = `backup-before-cleanup-${Date.now()}`;
  
  execSync(`git checkout -b ${backupBranch}`, { stdio: 'inherit' });
  console.log(`   ‚úì Branche de sauvegarde cr√©√©e: ${backupBranch}`);
  
  execSync(`git push origin ${backupBranch}`, { stdio: 'inherit' });
  console.log(`   ‚úì Branche pouss√©e sur origin`);
  
  execSync(`git checkout ${currentBranch}`, { stdio: 'inherit' });
  console.log(`   ‚úì Retour √† ${currentBranch}\n`);
} catch (err) {
  console.error('‚ùå Erreur lors de la cr√©ation de la sauvegarde');
  console.error('   Voulez-vous continuer sans sauvegarde? (Ctrl+C pour annuler)');
  // In a real script, you'd wait for user input here
}

// Delete files
console.log('üóëÔ∏è  Suppression des fichiers...');
const deleted = [];
const failed = [];

for (const file of filesToDelete) {
  try {
    if (fs.existsSync(file)) {
      execSync(`git rm "${file}"`, { stdio: 'pipe' });
      deleted.push(file);
      console.log(`   ‚úì ${file}`);
    } else {
      console.log(`   ‚ö†Ô∏è  Fichier introuvable: ${file}`);
      failed.push(file);
    }
  } catch (err) {
    console.error(`   ‚ùå Erreur: ${file}`);
    failed.push(file);
  }
}

console.log('');

// Summary
if (deleted.length > 0) {
  console.log(`‚úÖ ${deleted.length} fichier(s) supprim√©(s)`);
  
  // Calculate space saved
  const spaceFreed = deleted.reduce((sum, file) => {
    const fileData = analysisData.potentiallyRemovable.find(f => f.path === file);
    return sum + (fileData ? fileData.size : 0);
  }, 0);
  
  const formatBytes = (bytes) => {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };
  
  console.log(`üíæ Espace lib√©r√©: ${formatBytes(spaceFreed)}`);
  console.log('');
  
  console.log('üìù Prochaines √©tapes:');
  console.log('   1. V√©rifiez les changements: git status');
  console.log('   2. Testez le projet pour confirmer qu\'il fonctionne');
  console.log('   3. Commitez: git commit -m "Clean up: remove unnecessary files"');
  console.log('   4. Poussez: git push origin <branch>');
}

if (failed.length > 0) {
  console.log(`‚ö†Ô∏è  ${failed.length} fichier(s) non supprim√©(s)`);
  console.log('   Fichiers en √©chec:');
  failed.forEach(f => console.log(`   - ${f}`));
}

console.log('');
console.log('‚úÖ Nettoyage termin√©!');
